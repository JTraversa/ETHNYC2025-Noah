# FeiRari Vulnerability Post-Mortem

## A Review of Fei/Rari's Recent Vulnerability & Swivel's Path Forward

**Date not found**

**Likes:** 2

[![](https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F5d0b8ab9-3986-4a6e-9a5a-33c5cadc3f70_4445x2501.png)](https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F5d0b8ab9-3986-4a6e-9a5a-33c5cadc3f70_4445x2501.png)

This Saturday, April 30th at ~9:30 EDT (1:30 UTC), Rari Capital suffered a re-entrancy attack which left their pools insolvent to the tune of roughly ~$80 million.

This attack included the FEI market that we’ve integrated here at Swivel — FeiRari Pool 8.

* * *

## TL;DR:

As of now, May 2nd, ~90% of our user’s funds have been recovered, and ~198,000 FEI remain. 

With the FeiRari community call happening tomorrow at 8:00 PM ET (0:00 UTC), the Swivel DAO is initiating recovery SIP (#006) preemptively at 12:00 ET to give our community time to learn what steps the FeiRari DAO will take next before making our own conclusions, while also expediting the normal SIP process.

* * *

## The Vulnerability

Rari utilizes a fork of Compound’s money-market, which contains a relatively common re-entrancy vulnerability. 

Compound itself limits exposure to re-entrancy by restricting approved tokens to ERC-20s, however many forks have failed to do so leading to lender losses in individual vulnerabilities across [dForce](https://quantstamp.com/blog/how-the-dforce-hacker-used-reentrancy-to-steal-25-million)/[imBTC](https://zengo.com/imbtc-defi-hack-explained/), [CREAM](https://newsletter.thedefiant.io/p/-cream-finance-attack-leads-to-23), [Hundred Finance](https://rekt.news/agave-hundred-rekt/), [Voltage Finance](https://rekt.news/voltage-finance-rekt/), & [DefiPIE](https://www.bsc.news/post/defipie-gets-hacked-working-to-solve-issue-with-help-from-peckshield).

Last month security researchers @ **[samczsun](https://twitter.com/samczsun) ,** @ **[hritzdorf](https://twitter.com/HRitzdorf)** , and @ **[YSmaragdakis](https://twitter.com/YSmaragdakis) **noted a similar vulnerability in Rari’s cToken contracts and were met by a very quick remediation from the Rari team: [Report](https://medium.com/@JackLongarzo/rari-capital-fuse-security-upgrade-report-e5d154c16250)

During this remediation the Rari team utilized a global reentrancy guard on their cTokens, however in doing so their team failed to consider a potentially wider exposure scope and acknowledge that the Comptroller contract may need similar remediations.

The attacker was able to abuse an optimization for the transferring out of ETH, which had been added [only one month after their audit](https://twitter.com/Hacxyk/status/1520715536325218304) last year, meaning unaudited code has been live ever since.

[![](https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fcff434b5-6016-4755-b075-398816654b47_528x152.png)](https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fcff434b5-6016-4755-b075-398816654b47_528x152.png)

With this optimization and a lack of reentrant guard an attacker was able to:

  1. Flash loan and deposit 150,000,000 USDC into Rari

  2. Borrow ETH (triggering re-entrancy)

  3. Reentrant call `ExitMarkets()`, resetting debt to 0

  4. Repay Flashloan

  5. Repeat




[![Image](https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe82a42f4-6369-4329-ad3f-d0d0b36b0f9b_3098x1164.jpeg)](https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe82a42f4-6369-4329-ad3f-d0d0b36b0f9b_3098x1164.jpeg)Credit: PeckShield

* * *

## The Loss

The vulnerability has resulted in bad debt across pools: **8, 18, 27, 127, 144, 146, 156**

While the Rari team at first believed this vulnerability was limited in scope, it appears to extend to their Arbitrum deployment as well.

The attacker’s address: [0x6162….6157f](https://etherscan.io/address/0x6162759edad730152f0df8115c698a42e666157f)

[![](https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F30a810bf-8234-41eb-81f4-7f45fa0326e1_722x378.png)](https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F30a810bf-8234-41eb-81f4-7f45fa0326e1_722x378.png)

Attack Transaction: [0xab48….76530](https://etherscan.io/tx/0xab486012f21be741c9e674ffda227e30518e8a1e37a5f1d58d0b0d41f6e76530)  
Arbitrum Attack Transaction: [0x3212....203ef](https://arbiscan.io/tx/0x3212d091792f81f18a31aab753de6b3128d79dcb5e8392167249595f813203ef)

[Total funds lost:](https://twitter.com/starit1992/status/1520419032805306368)

 **ETH:** ~6,100  
 **FEI:** ~20,250,000  
 **DAI:** ~14,300,000  
 **FRAX:** ~13,100,000  
 **USDC:** ~10,100,000  
 **UST:** ~2,800,000  
 **LUSD:** ~2,000,000  
 **USDT:** ~130,000  
 **RAI:** ~32,000

 **Total: ~$80,110,000**

* * *

## Swivel’s Exposure

With the [launch of our FeiRari market](https://mirror.xyz/traversa.eth/ska63uIvWwNjIjueK6R2_ahMHGvYb1VE4k4AadDUt9E), we saw a handful of new faces from the FeiRari tribe come lend through our markets.

We had roughly ~2,000,000 FEI lent through our Rari that was vulnerable; however, with the vulnerability limited in its execution, significant amounts FEI remained in FeiRari Pool 8 for withdrawal.

That said, the moment the hack became public, we quickly rushed to inform our community of the vulnerability through Discord, and more importantly reach out specifically to those affected. 

With the tight knit size of our community, and significant engagement we have had in the past, we were able to get into personal contact with nearly all of our affected lenders, and have already recovered nearly 90% of our user’s funds.

That said, roughly 1,780,674,870,194,790 fFEI tokens (~198,000 FEI) remain in our Swivel contracts, leaving us a few options for additional recovery.

* * *

## The TRIBE’s Next Step

As of now the FeiRari community is waiting with breath held for the community call tomorrow at 8:00 PM ET (0:00 UTC) for more information on potential ways forward and their plans for recovery.

As of now, the FeiRari team has made no commitments, however have offered a _very_ significant whitehat bounty of $10,000,000 for the return of funds.

The FEI team sent the attacker the following message through an ETH transaction:

> We noticed you may be considering the no-questions-asked $10m offer. If you wish to take us up on this, please deposit the remaining funds to the Tribe DAO Timelock: 0xd51dbA7a94e1adEa403553A8235C302cEbF41a3c

* * *

## Swivel’s Next Step

With a bounty representing 12.5% of the vulnerability itself, Rari’s attacker may yet return funds (and Swivel’s exposure is limited). However, erring on the side of caution we have begun to prepare our emergency withdrawal procedures. 

We will be immediately launching SIP (#006) Maturing Our FeiRari Market Early, with votes beginning at 12:00 UTC on May 2nd, 2022. This timeline hopefully gives our community time to listen in to the FeiRari community call and weigh their path forward with regard to our own.

[![](https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb53dfb41-ce8a-4476-9684-ca4c0163bee8_981x460.png)](https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb53dfb41-ce8a-4476-9684-ca4c0163bee8_981x460.png)

### Potential Paths:

#### Fund Recovery:

The first path is the completion and early maturity of our Rari FEI market. 

Assuming Rari Pool 8 has FEI for withdrawal once our withdrawal queue completes:

  *  **zcFEI:** Redeemable for FEI at a ratio of 99:100

  *  **nFEI:** Redeemable for FEI at a ratio of 1:100

  *  **Redeemable FEI:** Reedemable for FEI 1:1 (Calculated based on the exchangeRate at 0:00 UTC on 5-2)




The market itself would close until further notice, and an additional market would launch ASAP alongside our imminent Arbitrum launch.

#### FeiRari Recovery:

Depending on the response of the FeiRari DAO on tomorrows call, it may also make sense to continue the market as is, and trust in their recovery processes.

With significant PCV in both Rari/Tribe treasuries, and our funds specifically all in FEI within the FeiRari pool, our depositors likely will be able to redeem funds at or near face value. 

The result would be that our market continues to operate as it has, with our impacted liquidity providers having earned significant rewards for their trust in our systems.

* * *

## Conclusion

We will keep our community updated continuously as the situation progresses.

We were lucky to be able to recover 90% of our users’ funds, and given the current state of the FeiRari pool, we are very likely to recover 100% of user funds and continue operations as usual within the week.

I’d like to personally thank all our community members for sticking around through all this, and to those who we’re impacted and able to respond quickly, thank you for being here along for the ride! 

Outside our updates on the progressing recovery, keep your eyes on for a piece on our development processes and how we ensure that our own contracts avoid similar pitfalls. (Hint: Check out my recent talk with Yield’s Alberto — [Link](https://www.youtube.com/watch?v=9ZDFITjp-QI))

— Julian Traversa

* * *

###  **About Swivel Finance**

Swivel is the protocol for fixed-rate lending and tokenized cash-flows.

Currently live on[ Rinkeby](https://rinkeby.swivel.exchange/) and on[ Mainnet](https://mainnet.swivel.exchange/), Swivel provides lenders the most efficient way to lock in a fixed rate as well as trade rates, and liquidity providers the most familiar and effective way to manage their inventory.

* * *

[Website](https://swivel.finance/) | [Substack](https://swivel.substack.com/) | [Discord](https://discord.gg/SkYskDQyVY) | [Twitter](https://twitter.com/SwivelFinance) | [Github](https://github.com/Swivel-Finance) | [Gitcoin](https://gitcoin.co/grants/1773/swivel-finance) | [Careers](https://angel.co/swivel-finance/recruiting/listings)

* * *
